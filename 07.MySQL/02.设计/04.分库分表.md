<details>
<summary>点击展开目录</summary>
<!-- TOC -->

- [关于](#关于)
- [分表](#分表)
    - [水平切分](#水平切分)
    - [垂直切分](#垂直切分)
    - [分表的问题](#分表的问题)
- [分库](#分库)
- [实践](#实践)
- [参考](#参考)

<!-- /TOC -->
</details>

## 关于

分库分表就是为了解决由于数据量过大而导致数据库性能降低的问题, 将原来独立的数据库拆分成若干数据库组成, 将数据大表拆分成若干数据表组成, 使得单一数据库、单一数据表的数据量变小, 从而达到提升数据库性能的目的.

此逻辑需要由调用方自己实现.

都可以按照垂直分和水平分的方式来实现.

缺点:
1. 分库分表后, 数据分布在不同的服务器, 存在分布式事务问题.
2. 跨节点关联查询, 需要查询多个节点后合并.
3. 跨节点排序、分页. 需要将不同节点的数据排序并返回, 然后对不同节点返回的数据进行汇总排序.
4. 可能需要分布式唯一id.

当单表数据量达到500w或2GB, 就需要进行分库分表. 尽量在分库分表的同时, 设计一个降级方案, 比如将数据转存一份到ES, 由ES进行大数据聚合查询.


## 分表

解决单表数据量过大带来的查询效率下降的问题

### 水平切分

1. 把一个表的数据分到多个表中, 每个表的结构相同, 能够提高查询性能
2. 自增主键可能会出现冲突, 除非主键带有唯一性的意义
3. 由于数据仍然处于同一个库中, 库级别仍有IO瓶颈

分表策略:

* 随机切分: hash, mod等基于一定的策略决定某条数据存储在那个子表中
* 连续切分: 将一定量连续数据放在一张表表中, 如某些数据使用频繁, 就会出现热点表, 违背了分表目的

### 垂直切分

1. 把一个表的字段分到多个表中, 每个表的字段不同
2. 分开的表中数据通过主键等关联

### 分表的问题

1. 表关联: 需要进行表关联时, 处理起来会麻烦, 不能简单的将所有子表进行join
2. 分布式事务: 数据一致性
3. 数据id问题: 如MySQL不能使用自增的id, 而应该使用全局唯一id, 如UUID等

## 分库

提高数据库并发访问能力, 主要是写操作

**垂直分**

适用于单库中表的数量较多的场景, 如把一部分表单独分到另外库中

按业务进行划分, 实现专库专用, 将数据按照业务划分到不同的数据库及表.

* 实现简单
* 存在跨库join查询问题, 无法解决单表数据量大的问题
* 事务问题, 如一个业务操作写了多个库的表, 如何保证事务的特性
* 来不及应对业务需求快速变化
* 无法真正的解决单实例数据库的性能瓶颈
* 如果某个业务数据量及访问量大, 按垂直分的方式还是会有性能瓶颈.

**水平分**

适用于单表中数据量极大的场景, 被分出的表处于不同的库中

依靠某几个字段按照某种规则, 将数据分散至多个库及表中. 从理论上突破了单机数据量处理的瓶颈, 并且扩展相对自由, 是分库分表的标准解决方案.

**解决跨库join的一种方案**

常被join的表在每个库中都存留一份.但要求这些表很少被修改

表中保存"多余"的字段, 避免通过join去其他表获取该字段, 是一种空间换性能的方案

## 实践

**如何增加分库分表**

比如需要将100张表分为5个库1000张表

整体方案:
1. 先在新的datasource创建新的1000张表分为5个库, 分库分表都是通过业务id进行shard
2. 代码dao层上线双写逻辑, 通过开关控制, 先写老(取余100), 后写新(取余1000), 此时读老
3. 起一个task, 将老100张表中的所有数据取出来通过新的shard策略写到对应的新表中
4. 起数据校验task, 用老校验新, 校验一天新增的数据, 新表中是否都有
5. 跑几天没问题之后, 通过开关将代码逻辑切换为先写新后写老, 此时读新
6. task校验, 用新校验老, 校验一天新增的数据, 老表中是否有
7. 下掉老表的代码及删表

## 参考

https://www.cnblogs.com/wade-luffy/p/6096578.html
https://www.infoq.cn/article/key-steps-and-likely-problems-of-split-table
https://tech.meituan.com/2016/11/18/dianping-order-db-sharding.html

