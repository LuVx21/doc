<details>
<summary>点击展开目录</summary>

- [xxx](#xxx)

</details>

### setnx 分布式锁实现

> 什么是分布式锁

分布式锁是控制分布式系统或不同系统之间共同访问共享资源的一种锁表现

#### 分布式锁条件

- 互斥性: 在任意一个时刻, 只有一个客户端持有锁
- 无死锁: 即便持有锁的客户端崩溃或者其它意外事件, 锁仍然可以被获取
- 容错: 只要大部分 Redis 节点都活着, 客户端就可以获取和释放锁

#### 分布式锁的主要实现

- 数据库
- Memcached (add命令)
- Redis (setnx命令)
- Zookeeper (临时节点)

#### 单机 Redis 分布式锁

- 加锁: `set key value [EX seconds] [px milliseconds] [NX|XX]`, value 需要保证唯一
- 释放锁: 解锁时, 需要判断锁是否是自己的, 基于value值来判断. 通常使用 lua 脚本来判断
    - `if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end`
- 解决的问题
    - 锁超时问题, 超时后锁会自己释放
    - 释放了别人的锁的问题: 客户端A获取到锁后执行, 阻塞超时到锁解锁了, 后面B客户端拿到了锁, A阻塞执行完了, 执行释放锁就把B客户端的锁释放了,
    所以释放时需要判断 value 是否是自己设置的.
### Redis 分布式锁

> 为什么要分布式锁

为了确保在多个线程中, 多服务器中执行任务时, 能够达到一致性

> Redis 为什么可以做分布式锁

Redis 是单线程的(网络请求模块使用了一个线程, 所以不需要考虑并发性), 即一个线程处理所有网络请求, 其它模块仍用了多个线程.

> 如何用

使用 `setnx key value`即加锁, 其它线程再来设置会返回false
`del key` 释放锁

> 解决死锁

1. Redis控制: 使用 `setnx key value` 后, 立即使用 `expire key timeout` 设置有效期.
2. 其它服务器控制: 通过 `value` 设置为失效时的时间戳(比如当前+1s), 其它服务器在获取锁时发现锁还在, 且超过了有效期, 就直接来释放锁, 在释放锁这个过程, 需要使用 `GETSET key value` 来操作, 直接对这个key进行`getset`, 看返回值如果是过期的, 说明拿到了锁, 反之拿失败了. 拿失败的情况下, 需要放弃后续的操作了

> 缺陷

当master上加了锁, 还未同步到 slave 时, master down了, 这个时候 slave 成为了 master, 其中并没有锁, 这个时候就会出现多个客户端同时拿到锁的问题.

> 锁延期机制 (watch dog)

当客户端超过了key的生存时间还在操作, 想要继续有这个锁, 那么可以使用看门狗程序, 在生存时间内会定时查这个锁是否还在, 还在的话就延期

#### Redlock 算法

##### 申请锁

起 5 个 master 节点 (奇数个), 分布在不同的机房尽量保证可用性. 为了获取锁, client 会进行如下操作:

1. 得到当前的时间, 微秒单位
2. 尝试在5个实例上申请锁, 当然是用的是相同的 key 和 random value, 这里一个 client 需要合理设置与 master
节点沟通的 timeout 大小, 避免长时间和一个 fail 了的节点浪费时间
3. 当 client 在大于 3 个 master 上成功申请到锁时, 且它会计算申请锁消耗了多少时间, 这个时间由 获得锁的时间减去第一步的时间 得到,
如果锁的持续时长(lock validity time) 比流逝的时间多的话, 那么锁就真正获取到了
4. 如果锁申请到了, 那么锁真正的 lock validity time 应该是 origin (lock validity time) - 申请锁流逝的时间
5. 如果锁申请失败了, 那么它就会在少部分申请成功锁的 master 节点上执行释放锁操作, 重置状态

##### 失败重试

尽快释放掉以获取的 master 节点上的锁, 等待随机时间后再去重试获取锁

##### 放锁

依次释放所有节点上的锁就可以了


## 如果redis作为分布式锁的时候, 主节点挂掉了, 但是数据还没有同步到从节点, 这种情况怎么办？

可以使用 RedLock 算法来实现分布式锁服务, 主节点 cash 后, 从节点顶替主节点, 需要等待一个锁超时时间后在替代.