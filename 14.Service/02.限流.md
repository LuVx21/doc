<details>
<summary>点击展开目录</summary>

- [算法](#算法)
- [限流对象](#限流对象)
- [阈值怎么算](#阈值怎么算)

</details>


## 算法

静态算法

1. 计数器: 不阻拦请求的进入, 请求的数量达到 qps 后, 后续请求不处理, 直至过了单位时间
2. 漏斗: 相当于更细的 qps, 如每秒 100 个, 转化为每10 毫秒处理一个, 平滑速率, 流量激增时对服务来说仍是稳定的请求速率, 请求阻塞在漏斗内
3. 令牌桶: 桶中放置 qps 数量的令牌, 请求拿到令牌才进行处理, 并以一种机制向桶中放置令牌. 能解决突然增加的请求问题

|      | 窗口                                                                                         | 令牌桶                               | 漏斗                                                                                           |
| :--- | :------------------------------------------------------------------------------------------- | :----------------------------------- | :--------------------------------------------------------------------------------------------- |
| 思想 | 固定窗口和滑动窗口;不阻拦请求的进入, 请求的数量达到 qps 后, 后续请求不处理, 直至过了单位时间 |                                      | 请求量曲线打平(错峰处理), 请求以不均匀的速度到达服务器之后, 限流器会以固定的速率转交给业务逻辑 |
| 优点 |                                                                                              | 流量激增能及时处理,效率高            | 不受流量激增影响                                                                               |
| 缺点 | 无法应对单位时间内集中式请求                                                                 |                                      | 流量激增,处理速率不变,可能丢弃较多请求,缺乏效率                                                |
| 场景 |                                                                                              | 有突发特性的流量, 且流量需要即时处理 | 间隔性突发流量且流量不用即时处理                                                               |
| 使用 |                                                                                              | Guava的RateLimiter                   | Sentinel中的匀速排队限流策略                                                                   |

---

动态算法也叫做自适应限流算法, 典型的是 BBR 算法

在Sentinel中, 关于流量控制有两种方式: 一种是通过并发线程数进行流量控制, 另一种是通过QPS指标进行流量控制.

**并发线程数**

请求过多, 线程池内的线程使用量超过阈值时, 采取策略处理;

**QPS指标**

QPS达到阈值时, 采取限流措施, Sentinel提供了三种流量控制策略, 分别是直接拒绝(系统处理能力已知时使用)、预热(Warm Up, 缓慢增加QPS直至上限或到达最大处理能力)和匀速排队(漏斗策略)

## 限流对象

VIP 用户不限流
针对 IP 限流: 同一个ip的登录请求
业务 ID 限流

## 阈值怎么算

* 看服务的观测数据(业务性能数据)
* 压测
* 借鉴
* 手动计算
