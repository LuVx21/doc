<details>
<summary>点击展开目录</summary>

- [熔断](#熔断)
  - [阈值](#阈值)
- [场景](#场景)
- [恢复](#恢复)

</details>


## 熔断

防止上下游调用中, 某个服务由于某种原因出错, 导致整个分布式调用链路失败.

目标为:
1. 在发现有服务调用失败后, 及时计算失败率
2. 失败率达到某种阈值时, 切断与该服务的所有交互, 服务走切断后的自定义逻辑
3. 切断并且不再调用该服务后主动监听被切断的服务是否已经恢复处理能力, 若恢复, 则继续让其提供服务

### 阈值

超过阈值并持续一段时间之后就会触发熔断, 此时新请求会被拒绝, 而已有的请求还是会被继续处理, 直到服务恢复正常

`一段时间`: 基于个人经验, 过长可能不易触发, 过短可能出现抖动

抖动(服务频繁地在正常-熔断两个状态之间切换)
* 一旦超过阈值就进入熔断状态
* 恢复策略不当

## 场景

加载弹幕时, 每条弹幕的点赞数、举报数的获取, 可以作为可熔断服务.

## 恢复

熔断恢复:
* 平滑恢复流量
* 客户端控制流量(负载均衡)

结合负载均衡的思想, 在客户端做熔断恢复:
1. 服务端在触发熔断的时候, 会返回一个代表熔断的错误.
2. 客户端在收到这个错误之后, 就会把这个服务端节点暂时挪出可用节点列表. 后续所有的新请求都不会再打到这个触发了熔断的服务端节点上了.
3. 客户端在等待一段时间后, 逐步放开流量.
4. 如果服务端正常处理了新来的请求, 那么客户端就加大流量.
5. 如果服务端再次返回了熔断响应, 那么客户端就会再一次将这个节点挪出可用列表.
6. 如此循环, 直到服务端完全恢复正常, 客户端也正常发送请求到该服务端节点.

工具: Hystrix, Sentinel
